<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General AI Query</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            background-color: var(--bs-body-bg);
            color: var(--bs-body-color);
            transition: background-color 0.3s, color 0.3s;
            margin-bottom: 160px;
        }
        .container.my-3 {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 70vh;
            overflow-y: auto;
            scrollbar-width: none;
        }
        .container.my-3::-webkit-scrollbar {
            display: none;
        }
        .message-prompt, .message-response { 
            padding: 10px 15px; 
            border-radius: 20px; 
            max-width: 75%; 
            word-wrap: break-word; 
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .message-prompt { 
            align-self: flex-end; 
            background-color: #d1e7dd; 
        }
        .message-response { 
            align-self: flex-start; 
            background-color: #f8f9fa; 
            position: relative;
            max-width: 100%;
        }
        html[data-bs-theme="dark"] .message-prompt { 
            background-color: #495057; 
            color: #f8f9fa; 
        }
        html[data-bs-theme="dark"] .message-response { 
            background-color: #343a40; 
            color: #f8f9fa; 
        }
        #remaining-messages {
            font-size: 0.9rem;
            text-align: right;
            transition: color 0.3s;
        }
        #remaining-messages.neutral {
            color: #28a745;
        }
        #remaining-messages.warning {
            color: #ffc107;
        }
        #remaining-messages.urgent {
            color: #fd7e14;
        }
        #remaining-messages.critical {
            color: #dc3545;
        }
        html[data-bs-theme="dark"] #remaining-messages.neutral {
            color: #32CD32;
        }
        html[data-bs-theme="dark"] #remaining-messages.warning {
            color: #FFD700;
        }
        html[data-bs-theme="dark"] #remaining-messages.urgent {
            color: #FFA500;
        }
        html[data-bs-theme="dark"] #remaining-messages.critical {
            color: #FF4500;
        }
        .prompt-container { 
            position: fixed; 
            bottom: 10px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 90%; 
            max-width: 800px; 
            background-color: white; 
            padding: 15px; 
            border-radius: 20px;
            border: 1px solid #ced4da;
            box-shadow: 0 -2px 6px rgba(0,0,0,0.1); 
            z-index: 1000; 
            transition: background-color 0.3s, border-color 0.3s;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }
        .prompt-container.dark {
            background-color: #2c2c2c;
            border-color: #555;
        }
        #controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #attach-btn {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #6c757d;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s;
            flex-shrink: 0;
        }
        #attach-btn:hover {
            opacity: 0.8;
            background-color: #5a6268;
        }
        .prompt-container.dark #attach-btn {
            background-color: #555;
            color: white;
        }
        #query {
            flex: 1;
            resize: none;
            border-radius: 50px;
            padding: 10px 20px;
            border: 1px solid #ced4da;
            outline: none;
            transition: border-color 0.3s;
            height: 68px;
            background-color: #fff;
            color: #000;
            overflow-y: scroll;
            scrollbar-width: none;
        }
        #query:focus {
            border-color: #0d6efd;
        }
        #query::-webkit-scrollbar {
            display: none;
        }
        .prompt-container.dark #query {
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
        }
        #send-btn {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #0d6efd;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s;
            position: relative;
            flex-shrink: 0;
        }
        #send-btn.loading {
            pointer-events: none;
            opacity: 0.6;
        }
        #send-btn .spinner-border {
            position: absolute;
            width: 1rem;
            height: 1rem;
            display: none;
        }
        #send-btn.loading .spinner-border {
            display: inline-block;
        }
        #send-btn.loading .fa-arrow-up {
            display: none;
        }
        #send-btn:hover {
            opacity: 0.8;
            background-color: #0b5ed7;
        }
        .prompt-container.dark #send-btn {
            background-color: #fff;
            color: #000;
        }
        .prompt-container.dark #send-btn .spinner-border {
            color: #000;
        }
        .prompt-container #send-btn .spinner-border {
            color: #fff;
        }
        #remaining-messages {
            font-size: 0.9rem;
            color: #6c757d;
            text-align: right;
        }
        .theme-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 25px;
        }
        .theme-toggle input {
            display: none;
        }
        .theme-toggle-label {
            position: absolute;
            cursor: pointer;
            width: 100%;
            height: 100%;
            background-color: #ddd;
            border-radius: 15px;
            transition: background-color 0.3s;
        }
        .theme-toggle-label:before {
            content: '';
            position: absolute;
            left: 2px;
            top: 2px;
            width: 21px;
            height: 21px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .theme-toggle input:checked + .theme-toggle-label {
            background-color: #4d4d4d;
        }
        .theme-toggle input:checked + .theme-toggle-label:before {
            transform: translateX(25px);
        }
        .theme-toggle-label .fa-sun,
        .theme-toggle-label .fa-moon {
            position: absolute;
            top: 5px;
            font-size: 15px;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .theme-toggle-label .fa-sun {
            left: 5px;
            color: #f1c40f;
            opacity: 1;
        }
        .theme-toggle-label .fa-moon {
            right: 5px;
            color: #ecf0f1;
            opacity: 0;
        }
        .theme-toggle input:checked + .theme-toggle-label .fa-sun {
            opacity: 0;
        }
        .theme-toggle input:checked + .theme-toggle-label .fa-moon {
            opacity: 1;
        }
        html[data-bs-theme="dark"] .theme-toggle-label .fa-sun {
            color: #f39c12;
        }
        html[data-bs-theme="dark"] .theme-toggle-label .fa-moon {
            color: #ecf0f1;
        }
        #notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            display: none;
        }
        #notification-toast.show {
            display: block;
        }
        .file-display {
            flex: 0 0 auto;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem;
            border-radius: 1rem;
            background-color: #f8f9fa;
            color: #212529;
            position: relative;
            width: 200px;
        }
        .file-display.dark {
            background-color: #000;
            color: #fff;
        }
        .file-icon {
            flex-shrink: 0;
            width: 2.5rem;
            height: 2.5rem;
            overflow: hidden;
            border-radius: 0.375rem;
            background-color: #FF5588;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .file-icon svg {
            width: 1.5rem;
            height: 1.5rem;
            color: #fff;
        }
        .file-info {
            flex: 1;
            overflow: hidden;
        }
        .file-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .file-type {
            color: #6c757d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .remove-file-btn {
            background-color: transparent;
            border: none;
            color: #dc3545;
            cursor: pointer;
            transition: color 0.3s;
        }
        .remove-file-btn:hover {
            color: #a71d2a;
        }
        .file-display.dark .file-type {
            color: #adb5bd;
        }
        .file-display.dark .remove-file-btn {
            color: #f8f9fa;
        }
        .navbar-divider {
            width: 1px;
            height: 24px;
            background-color: #6c757d;
            margin: 0 1rem;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary sticky-top">
        <div class="container">
            <a id="home-link" class="navbar-brand fs-3" href="#" title="General AI Query">
                <i class="fas fa-fw fa-home"></i> General AI Query
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" 
              aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <div class="d-flex align-items-center ms-auto flex-wrap">
                    <button id="reset-chat" class="btn btn-outline-danger me-3">Reset Chat</button>
                    <div class="navbar-divider"></div>
                    <div class="theme-toggle me-3">
                        <input type="checkbox" id="theme-toggle-checkbox">
                        <label for="theme-toggle-checkbox" class="theme-toggle-label">
                            <i class="fas fa-sun"></i>
                            <i class="fas fa-moon"></i>
                        </label>
                    </div>
                    <div class="navbar-divider"></div>
                </div>
            </div>
        </div>
    </nav>

    <div id="notification-toast"></div>

    <div class="container my-3"></div>

    <div class="prompt-container">
        <div id="file-list"></div>
        <div id="controls">
            <button type="button" id="attach-btn" aria-label="Attach files">
                <i class="fas fa-paperclip"></i>
            </button>
            <textarea placeholder="Ask me anything" rows="2" id="query" class="form-control"></textarea>
            <button id="send-btn" aria-label="Send prompt">
                <i class="fas fa-fw fa-arrow-up"></i>
                <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </button>
        </div>
        <div id="remaining-messages" class="me-3 neutral">Remaining messages: 10</div>
    </div>

    <template id="file-display-template">
        <div class="file-display">
            <div class="file-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36" fill="none" width="36" height="36">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4Z" fill="currentColor"/>
                </svg>
            </div>
            <div class="overflow-hidden file-info">
                <div class="file-name">File Name.pdf</div>
                <div class="file-type">PDF</div>
            </div>
            <button class="remove-file-btn" aria-label="Remove file">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </template>

    <template id="chat-file-display-template">
        <div class="file-display">
            <div class="file-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36" fill="none" width="36" height="36">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4Z" fill="currentColor"/>
                </svg>
            </div>
            <div class="overflow-hidden file-info">
                <div class="file-name">Training language models to follow instructions with human feedback.pdf</div>
                <div class="file-type">PDF</div>
            </div>
        </div>
    </template>

    <template id="notification-template">
        <div class="toast align-items-center text-bg-danger border-0 show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    You can add at most 5 attachments to a message. Please select fewer attachments.
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close"></button>
            </div>
        </div>
    </template>

    <template id="generic-notification-template">
        <div class="toast align-items-center text-bg-success border-0 show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    Success message here.
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close"></button>
            </div>
        </div>
    </template>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYF0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(window.location.search);
            const site_url = params.get('site_url');
            if (site_url) {
                const homeLink = document.getElementById('home-link');
                if (homeLink) {
                    homeLink.href = site_url;
                }
            }

            fetch('/api/create_session', {
                method: 'GET',
                credentials: 'include'
            }).then(response => {
                if (!response.ok) {
                    console.error('Failed to create session');
                }
            }).catch(error => {
                console.error('Error creating session:', error);
            });

            const themeToggleCheckbox = document.getElementById('theme-toggle-checkbox');

            let theme = localStorage.getItem('theme') || 'light';
            applyTheme(theme);

            themeToggleCheckbox.checked = (theme === 'dark');

            themeToggleCheckbox.addEventListener('change', () => {
                theme = themeToggleCheckbox.checked ? 'dark' : 'light';
                localStorage.setItem('theme', theme);
                applyTheme(theme);
                const remainingMessagesEl = document.getElementById('remaining-messages');
                const count = parseInt(remainingMessagesEl.textContent.replace('Remaining messages: ', '')) || 10;
                updateRemainingMessages(count);
            });

            function applyTheme(theme) {
                document.documentElement.setAttribute('data-bs-theme', theme);

                const promptContainer = document.querySelector('.prompt-container');
                const sendBtn = document.getElementById('send-btn');
                const navbar = document.querySelector('.navbar');

                if (theme === 'dark') {
                    promptContainer.classList.add('dark');
                    sendBtn.classList.add('dark');
                    navbar.classList.remove('navbar-light', 'bg-body-tertiary');
                    navbar.classList.add('navbar-dark', 'bg-dark');
                    document.querySelectorAll('.file-display').forEach(fd => fd.classList.add('dark'));
                } else {
                    promptContainer.classList.remove('dark');
                    sendBtn.classList.remove('dark');
                    navbar.classList.remove('navbar-dark', 'bg-dark');
                    navbar.classList.add('navbar-light', 'bg-body-tertiary');
                    document.querySelectorAll('.file-display').forEach(fd => fd.classList.remove('dark'));
                }
            }

            let isSending = false;

            const textarea = document.getElementById('query');
            textarea.addEventListener('input', adjustHeight);
            function adjustHeight() {
                textarea.style.height = 'auto';
                const rowHeight = parseInt(getComputedStyle(textarea).lineHeight, 10);
                const minRows = 1;
                const maxRows = 6;
                const currentRows = Math.min(Math.max(textarea.scrollHeight / rowHeight, minRows), maxRows);	
                textarea.style.height = `${currentRows * rowHeight}px`;
            }
            adjustHeight();

            function updateRemainingMessages(count) {
                const remainingMessagesEl = document.getElementById('remaining-messages');
                const totalMessages = 10;
                const percentageRemaining = (count / totalMessages) * 100;

                remainingMessagesEl.textContent = `Remaining messages: ${count}`;

                remainingMessagesEl.classList.remove('neutral', 'warning', 'urgent', 'critical');

                if (percentageRemaining > 75) {
                    remainingMessagesEl.classList.add('neutral');
                } else if (percentageRemaining > 50) {
                    remainingMessagesEl.classList.add('warning');
                } else if (percentageRemaining > 25) {
                    remainingMessagesEl.classList.add('urgent');
                } else {
                    remainingMessagesEl.classList.add('critical');
                }

                if (count <= 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'No Remaining Messages',
                        text: 'You have exhausted all remaining messages. Please reset the chat to continue.'
                    });
                }
            }

            const initialCount = parseInt(document.getElementById('remaining-messages').textContent.replace('Remaining messages: ', '')) || 10;
            updateRemainingMessages(initialCount);

            async function submitPrompt() {
                if (isSending) {
                    return;
                }
                isSending = true;
                const query = document.getElementById('query').value.trim();
                const resultsContainer = document.querySelector('.container.my-3');
                const sendBtn = document.getElementById('send-btn');
                const remainingMessagesEl = document.getElementById('remaining-messages');
                const fileListEl = document.getElementById('file-list');

                let remainingMessages = parseInt(remainingMessagesEl.textContent.replace('Remaining messages: ', '')) || 10;

                const files = Array.from(fileListEl.children).slice(0, 5).map(div => div.file);

                if( query || files.length > 0 ) {
                    sendBtn.classList.add('loading');

                    const formData = new FormData();
                    formData.append('query', query);

                    files.forEach((file, index) => {
                        formData.append('file', file);
                    });

                    const promptElement = document.createElement('div');
                    promptElement.classList.add('message-prompt');

                    if (query) {
                        const messageText = document.createElement('div');
                        messageText.innerHTML = marked.parse(query);
                        promptElement.appendChild(messageText);
                    }

                    if (files.length > 0) {
                        const filesContainer = document.createElement('div');
                        filesContainer.classList.add('files-container');
                        files.forEach(file => {
                            const fileDisplay = createChatFileDisplay(file);
                            filesContainer.appendChild(fileDisplay);
                        });
                        promptElement.appendChild(filesContainer);
                    }

                    resultsContainer.appendChild(promptElement);

                    document.getElementById('query').value = '';
                    fileListEl.innerHTML = '';
                    adjustHeight();

                    try {
                        const response = await fetch('/api/query', {
                            method: 'POST',
                            body: formData,
                            credentials: 'include'
                        });

                        if (!response.ok) {
                            if (response.status === 401) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Unauthorized',
                                    text: 'Your session has expired or is invalid. Please refresh the page.'
                                });
                            } else {
                                throw new Error('Network response was not ok');
                            }
                            return;
                        }

                        if (!response.body) {
                            throw new Error('ReadableStream not supported in this browser.');
                        }

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let messageContent = '';
                        const responseElement = document.createElement('div');
                        responseElement.classList.add('message-response');

                        resultsContainer.appendChild(responseElement);

                        const renderEveryNTokens = 5;
                        let tokenCounter = 0;

                        while (true) {
                            const { value, done } = await reader.read();
                            if (done) break;

                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n');

                            for (const line of lines) {
                                if (line.startsWith('data:')) {
                                    const jsonData = line.slice(5).trim();
                                    if (jsonData === '[DONE]') {
                                        break;
                                    }

                                    try {
                                        const data = JSON.parse(jsonData);
                                        if (data.content) {
                                            messageContent += data.content;
                                            tokenCounter++;

                                            if (tokenCounter % renderEveryNTokens === 0) {
                                                const tempElement = document.createElement('div');
                                                tempElement.innerHTML = messageContent;
                                                MathJax.typesetPromise([tempElement]).then(() => {
                                                    responseElement.innerHTML = marked.parse(tempElement.innerHTML);
                                                    MathJax.typesetPromise([responseElement]).catch(function (err) {
                                                        console.error('MathJax typeset failed:', err);
                                                    });
                                                }).catch(function (err) {
                                                    console.error('MathJax typeset failed:', err);
                                                });
                                            }
                                        }
                                        if (data.remaining_messages !== undefined) {
                                            updateRemainingMessages(data.remaining_messages);
                                        }
                                        if (data.error) {
                                            Swal.fire({
                                                icon: 'error',
                                                title: 'Error',
                                                text: data.error
                                            });
                                        }
                                    } catch (error) {
                                        console.error('Error parsing JSON:', error);
                                    }
                                }
                            }
                        }

                        if (messageContent) {
                            const tempElement = document.createElement('div');
                            tempElement.innerHTML = messageContent;
                            await MathJax.typesetPromise([tempElement]);
                            responseElement.innerHTML = marked.parse(tempElement.innerHTML);
                            await MathJax.typesetPromise([responseElement]);

                            const buttonContainer = document.createElement('div');
                            buttonContainer.classList.add('mt-2', 'd-flex', 'gap-2');

                            const copyButton = document.createElement('button');
                            copyButton.classList.add('btn', 'btn-sm', 'btn-outline-secondary');
                            copyButton.setAttribute('aria-label', 'Copy response');
                            copyButton.innerHTML = `
                                <span class="flex h-[30px] w-[30px] items-center justify-center">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-md-heavy">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M7 5C7 3.34315 8.34315 2 10 2H19C20.6569 2 22 3.34315 22 5V14C22 15.6569 20.6569 17 19 17H17V19C17 20.6569 15.6569 22 14 22H5C3.34315 22 2 20.6569 2 19V10C2 8.34315 3.34315 7 5 7H7V5ZM9 7H14C15.6569 7 17 8.34315 17 10V15H19C19.5523 15 20 14.5523 20 14V5C20 4.44772 19.5523 4 19 4H10C9.44772 4 9 4.44772 9 5V7ZM5 9C4.44772 9 4 9.44772 4 10V19C4 19.5523 4.44772 20 5 20H14C14.5523 20 15 19.5523 15 19V10C15 9.44772 14.5523 9 14 9H5Z" fill="currentColor"></path>
                                    </svg>
                                </span>
                            `;
                            copyButton.addEventListener('click', () => {
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = responseElement.innerHTML;
                                tempDiv.querySelectorAll('.btn').forEach(btn => btn.remove());
                                const textToCopy = tempDiv.innerText;
                                navigator.clipboard.writeText(textToCopy).then(() => {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Copied',
                                        text: 'Response copied to clipboard.',
                                        toast: true,
                                        position: 'top-end',
                                        showConfirmButton: false,
                                        timer: 1500,
                                        timerProgressBar: true
                                    });
                                }).catch(err => {
                                    console.error('Failed to copy text: ', err);
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: 'Failed to copy text.'
                                    });
                                });
                            });

                            const downloadButton = document.createElement('button');
                            downloadButton.classList.add('btn', 'btn-sm', 'btn-outline-primary');
                            downloadButton.setAttribute('aria-label', 'Download response as DOCX');
                            downloadButton.innerHTML = `
                                <span class="flex h-[30px] w-[30px] items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="icon-md-heavy">
                                        <path d="M12 16V4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M6 10L12 16L18 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M4 20H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            `;
                            downloadButton.addEventListener('click', () => {
                                const htmlContent = responseElement.innerHTML;
                                const fullHtml = `
                                    <html>
                                        <head>
                                            <meta charset="utf-8">
                                        </head>
                                        <body>
                                            ${htmlContent}
                                        </body>
                                    </html>
                                `;
                                const converted = htmlDocx.asBlob(fullHtml);
                                const url = URL.createObjectURL(converted);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = 'response.docx';
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                URL.revokeObjectURL(url);
                            });

                            buttonContainer.appendChild(copyButton);
                            buttonContainer.appendChild(downloadButton);
                            responseElement.appendChild(buttonContainer);
                        }

                    } catch (error) {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'An error occurred while processing your request. You need to reload the page.'
                        });
                    } finally {
                        sendBtn.classList.remove('loading');
                        isSending = false;
                    }
                } else { 
                    Swal.fire({
                        icon: 'info',
                        title: 'Error',
                        text: 'Please enter a question or attach files.'
                    }); 
                    isSending = false;
                    return; 
                }
            }

            function createChatFileDisplay(file) {
                const template = document.getElementById('chat-file-display-template');
                const fileDisplay = template.content.cloneNode(true).children[0];

                fileDisplay.querySelector('.file-name').textContent = file.name;
                const fileType = getFileType(file.name);
                fileDisplay.querySelector('.file-type').textContent = fileType;

                const fileIcon = fileDisplay.querySelector('.file-icon svg');
                if (fileType.toLowerCase() === 'pdf') {
                    fileIcon.innerHTML = `
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4Z" fill="currentColor"/>
                    `;
                } else if (fileType.toLowerCase() === 'docx' || fileType.toLowerCase() === 'doc') {
                    fileIcon.innerHTML = `
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4ZM10 12H14V14H10V12Z" fill="currentColor"/>
                    `;
                } else {
                    fileIcon.innerHTML = `
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4Z" fill="currentColor"/>
                    `;
                }

                var currentTheme = localStorage.getItem("theme");
                if (currentTheme === "dark") {
                    fileDisplay.classList.add('dark');
                }

                return fileDisplay;
            }

            function createAttachmentFileDisplay(file) {
                const template = document.getElementById('file-display-template');
                const fileDisplay = template.content.cloneNode(true).children[0];

                fileDisplay.querySelector('.file-name').textContent = file.name;
                const fileType = getFileType(file.name);
                fileDisplay.querySelector('.file-type').textContent = fileType;

                const fileIcon = fileDisplay.querySelector('.file-icon svg');
                if (fileType.toLowerCase() === 'pdf') {
                    fileIcon.innerHTML = `
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4ZM8 6C8 6.55228 7.55228 7 7 7C6.44772 7 6 6.55228 6 6C6 5.44772 6.44772 5 7 5C7.55228 5 8 5.44772 8 6ZM16 18H8V16H16V18Z" fill="currentColor"/>
                    `;
                } else if (fileType.toLowerCase() === 'docx' || fileType.toLowerCase() === 'doc') {
                    fileIcon.innerHTML = `
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4ZM10 12H14V14H10V12Z" fill="currentColor"/>
                    `;
                } else {
                    fileIcon.innerHTML = `
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4Z" fill="currentColor"/>
                    `;
                }

                fileDisplay.file = file;

                fileDisplay.querySelector('.remove-file-btn').addEventListener('click', () => {
                    fileDisplay.remove();
                });

                var currentTheme = localStorage.getItem("theme");
                if (currentTheme === "dark") {
                    fileDisplay.classList.add('dark');
                }

                return fileDisplay;
            }

            function getFileType(filename) {
                const extension = filename.split('.').pop().toLowerCase();
                const docTypes = ['docx', 'doc'];
                const pdfTypes = ['pdf'];
                const imageTypes = ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'svg'];

                if (pdfTypes.includes(extension)) return 'PDF';
                if (docTypes.includes(extension)) return 'DOCX';
                if (imageTypes.includes(extension)) return 'Image';
                return extension.toUpperCase();
            }

            document.getElementById('attach-btn').addEventListener('click', () => {
                const tempInput = document.createElement('input');
                tempInput.type = 'file';
                tempInput.multiple = true;
                tempInput.accept = '.txt,.pdf,.docx,.doc,.png,.jpg,.jpeg';
                tempInput.style.display = 'none';
                document.body.appendChild(tempInput);

                tempInput.addEventListener('change', (event) => {
                    const existingFilesCount = document.querySelectorAll('#file-list .file-display').length;
                    const selectedFiles = Array.from(event.target.files);
                    const totalFiles = existingFilesCount + selectedFiles.length;

                    if (totalFiles > 5) {
                        showNotification();
                        document.body.removeChild(tempInput);
                        return;
                    }

                    const fileListEl = document.getElementById('file-list');

                    selectedFiles.forEach(file => {
                        const fileDisplay = createAttachmentFileDisplay(file);
                        fileListEl.appendChild(fileDisplay);
                    });

                    document.body.removeChild(tempInput);
                });

                tempInput.click();
            });

            function showNotification() {
                const notificationToast = document.getElementById('notification-toast');
                const template = document.getElementById('notification-template');
                notificationToast.innerHTML = '';
                const notificationElement = template.content.cloneNode(true);
                notificationToast.appendChild(notificationElement);

                notificationToast.classList.add('show');

                const closeButton = notificationToast.querySelector('.btn-close');
                closeButton.addEventListener('click', () => {
                    notificationToast.classList.remove('show');
                });

                setTimeout(() => {
                    notificationToast.classList.remove('show');
                }, 5000);
            }

            document.getElementById('send-btn').addEventListener('click', async () => {
                if (isSending) {
                    return;
                }
                submitPrompt();
            });

            document.getElementById('query').addEventListener('keydown', event => {
                if( event.key === 'Enter' && !event.ctrlKey && !event.shiftKey && !event.altKey && !event.metaKey ) { 
                    if (isSending) {
                        event.preventDefault();
                        return;
                    }
                    submitPrompt(); 
                    event.preventDefault(); 
                }
            });

            document.getElementById('reset-chat').addEventListener('click', async () => {
                const confirmReset = await Swal.fire({
                    title: 'Are you sure?',
                    text: "This will reset the conversation.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, reset it!'
                });
                
                if (confirmReset.isConfirmed) {
                    try {
                        const response = await fetch('/api/reset_conversation', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include'
                        });
                        if (response.ok) {
                            const data = await response.json();
                            const container = document.querySelector('.container.my-3');
                            container.innerHTML = '';
                            updateRemainingMessages(data.remaining_messages);
                            Swal.fire({
                                icon: 'success',
                                title: 'Reset',
                                text: 'Conversation has been reset.'
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Failed to reset the conversation.'
                            });
                        }
                    } catch (error) {
                        console.error('Error resetting conversation:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'An error occurred while resetting the conversation.'
                        });
                    }
                }
            });

            async function submitPrompt() {
                if (isSending) {
                    return;
                }
                isSending = true;
                const query = document.getElementById('query').value.trim();
                const resultsContainer = document.querySelector('.container.my-3');
                const sendBtn = document.getElementById('send-btn');
                const remainingMessagesEl = document.getElementById('remaining-messages');
                const fileListEl = document.getElementById('file-list');

                let remainingMessages = parseInt(remainingMessagesEl.textContent.replace('Remaining messages: ', '')) || 10;

                const files = Array.from(fileListEl.children).slice(0, 5).map(div => div.file);

                if( query || files.length > 0 ) {
                    sendBtn.classList.add('loading');

                    const formData = new FormData();
                    formData.append('query', query);

                    files.forEach((file, index) => {
                        formData.append('file', file);
                    });

                    const promptElement = document.createElement('div');
                    promptElement.classList.add('message-prompt');

                    if (query) {
                        const messageText = document.createElement('div');
                        messageText.innerHTML = marked.parse(query);
                        promptElement.appendChild(messageText);
                    }

                    if (files.length > 0) {
                        const filesContainer = document.createElement('div');
                        filesContainer.classList.add('files-container');
                        files.forEach(file => {
                            const fileDisplay = createChatFileDisplay(file);
                            filesContainer.appendChild(fileDisplay);
                        });
                        promptElement.appendChild(filesContainer);
                    }

                    resultsContainer.appendChild(promptElement);

                    document.getElementById('query').value = '';
                    fileListEl.innerHTML = '';
                    adjustHeight();

                    try {
                        const response = await fetch('/api/query', {
                            method: 'POST',
                            body: formData,
                            credentials: 'include'
                        });

                        if (!response.ok) {
                            if (response.status === 401) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Unauthorized',
                                    text: 'Your session has expired or is invalid. Please refresh the page.'
                                });
                            } else {
                                throw new Error('Network response was not ok');
                            }
                            return;
                        }

                        if (!response.body) {
                            throw new Error('ReadableStream not supported in this browser.');
                        }

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let messageContent = '';
                        const responseElement = document.createElement('div');
                        responseElement.classList.add('message-response');

                        resultsContainer.appendChild(responseElement);

                        const renderEveryNTokens = 5;
                        let tokenCounter = 0;

                        while (true) {
                            const { value, done } = await reader.read();
                            if (done) break;

                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n');

                            for (const line of lines) {
                                if (line.startsWith('data:')) {
                                    const jsonData = line.slice(5).trim();
                                    if (jsonData === '[DONE]') {
                                        break;
                                    }

                                    try {
                                        const data = JSON.parse(jsonData);
                                        if (data.content) {
                                            messageContent += data.content;
                                            tokenCounter++;

                                            if (tokenCounter % renderEveryNTokens === 0) {
                                                const tempElement = document.createElement('div');
                                                tempElement.innerHTML = messageContent;
                                                MathJax.typesetPromise([tempElement]).then(() => {
                                                    responseElement.innerHTML = marked.parse(tempElement.innerHTML);
                                                    MathJax.typesetPromise([responseElement]).catch(function (err) {
                                                        console.error('MathJax typeset failed:', err);
                                                    });
                                                }).catch(function (err) {
                                                    console.error('MathJax typeset failed:', err);
                                                });
                                            }
                                        }
                                        if (data.remaining_messages !== undefined) {
                                            updateRemainingMessages(data.remaining_messages);
                                        }
                                        if (data.error) {
                                            Swal.fire({
                                                icon: 'error',
                                                title: 'Error',
                                                text: data.error
                                            });
                                        }
                                    } catch (error) {
                                        console.error('Error parsing JSON:', error);
                                    }
                                }
                            }
                        }

                        if (messageContent) {
                            const tempElement = document.createElement('div');
                            tempElement.innerHTML = messageContent;
                            await MathJax.typesetPromise([tempElement]);
                            responseElement.innerHTML = marked.parse(tempElement.innerHTML);
                            await MathJax.typesetPromise([responseElement]);

                            const buttonContainer = document.createElement('div');
                            buttonContainer.classList.add('mt-2', 'd-flex', 'gap-2');

                            const copyButton = document.createElement('button');
                            copyButton.classList.add('btn', 'btn-sm', 'btn-outline-secondary');
                            copyButton.setAttribute('aria-label', 'Copy response');
                            copyButton.innerHTML = `
                                <span class="flex h-[30px] w-[30px] items-center justify-center">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-md-heavy">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M7 5C7 3.34315 8.34315 2 10 2H19C20.6569 2 22 3.34315 22 5V14C22 15.6569 20.6569 17 19 17H17V19C17 20.6569 15.6569 22 14 22H5C3.34315 22 2 20.6569 2 19V10C2 8.34315 3.34315 7 5 7H7V5ZM9 7H14C15.6569 7 17 8.34315 17 10V15H19C19.5523 15 20 14.5523 20 14V5C20 4.44772 19.5523 4 19 4H10C9.44772 4 9 4.44772 9 5V7ZM5 9C4.44772 9 4 9.44772 4 10V19C4 19.5523 4.44772 20 5 20H14C14.5523 20 15 19.5523 15 19V10C15 9.44772 14.5523 9 14 9H5Z" fill="currentColor"></path>
                                    </svg>
                                </span>
                            `;
                            copyButton.addEventListener('click', () => {
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = responseElement.innerHTML;
                                tempDiv.querySelectorAll('.btn').forEach(btn => btn.remove());
                                const textToCopy = tempDiv.innerText;
                                navigator.clipboard.writeText(textToCopy).then(() => {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Copied',
                                        text: 'Response copied to clipboard.',
                                        toast: true,
                                        position: 'top-end',
                                        showConfirmButton: false,
                                        timer: 1500,
                                        timerProgressBar: true
                                    });
                                }).catch(err => {
                                    console.error('Failed to copy text: ', err);
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: 'Failed to copy text.'
                                    });
                                });
                            });

                            const downloadButton = document.createElement('button');
                            downloadButton.classList.add('btn', 'btn-sm', 'btn-outline-primary');
                            downloadButton.setAttribute('aria-label', 'Download response as DOCX');
                            downloadButton.innerHTML = `
                                <span class="flex h-[30px] w-[30px] items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="icon-md-heavy">
                                        <path d="M12 16V4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M6 10L12 16L18 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M4 20H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            `;
                            downloadButton.addEventListener('click', () => {
                                const htmlContent = responseElement.innerHTML;
                                const fullHtml = `
                                    <html>
                                        <head>
                                            <meta charset="utf-8">
                                        </head>
                                        <body>
                                            ${htmlContent}
                                        </body>
                                    </html>
                                `;
                                const converted = htmlDocx.asBlob(fullHtml);
                                const url = URL.createObjectURL(converted);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = 'response.docx';
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                URL.revokeObjectURL(url);
                            });

                            buttonContainer.appendChild(copyButton);
                            buttonContainer.appendChild(downloadButton);
                            responseElement.appendChild(buttonContainer);
                        }

                    } catch (error) {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'An error occurred while processing your request. You need to reload the page.'
                        });
                    } finally {
                        sendBtn.classList.remove('loading');
                        isSending = false;
                    }
                } else { 
                    Swal.fire({
                        icon: 'info',
                        title: 'Error',
                        text: 'Please enter a question or attach files.'
                    }); 
                    isSending = false;
                    return; 
                }
            }

            function createChatFileDisplay(file) {
                const template = document.getElementById('chat-file-display-template');
                const fileDisplay = template.content.cloneNode(true).children[0];

                fileDisplay.querySelector('.file-name').textContent = file.name;
                const fileType = getFileType(file.name);
                fileDisplay.querySelector('.file-type').textContent = fileType;

                const fileIcon = fileDisplay.querySelector('.file-icon svg');
                if (fileType.toLowerCase() === 'pdf') {
                    fileIcon.innerHTML = `
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4Z" fill="currentColor"/>
                    `;
                } else if (fileType.toLowerCase() === 'docx' || fileType.toLowerCase() === 'doc') {
                    fileIcon.innerHTML = `
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4ZM10 12H14V14H10V12Z" fill="currentColor"/>
                    `;
                } else {
                    fileIcon.innerHTML = `
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4Z" fill="currentColor"/>
                    `;
                }

                var currentTheme = localStorage.getItem("theme");
                if (currentTheme === "dark") {
                    fileDisplay.classList.add('dark');
                }

                return fileDisplay;
            }

            function createAttachmentFileDisplay(file) {
                const template = document.getElementById('file-display-template');
                const fileDisplay = template.content.cloneNode(true).children[0];

                fileDisplay.querySelector('.file-name').textContent = file.name;
                const fileType = getFileType(file.name);
                fileDisplay.querySelector('.file-type').textContent = fileType;

                const fileIcon = fileDisplay.querySelector('.file-icon svg');
                if (fileType.toLowerCase() === 'pdf') {
                    fileIcon.innerHTML = `
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4ZM8 6C8 6.55228 7.55228 7 7 7C6.44772 7 6 6.55228 6 6C6 5.44772 6.44772 5 7 5C7.55228 5 8 5.44772 8 6ZM16 18H8V16H16V18Z" fill="currentColor"/>
                    `;
                } else if (fileType.toLowerCase() === 'docx' || fileType.toLowerCase() === 'doc') {
                    fileIcon.innerHTML = `
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4ZM10 12H14V14H10V12Z" fill="currentColor"/>
                    `;
                } else {
                    fileIcon.innerHTML = `
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4Z" fill="currentColor"/>
                    `;
                }

                fileDisplay.file = file;

                fileDisplay.querySelector('.remove-file-btn').addEventListener('click', () => {
                    fileDisplay.remove();
                });

                var currentTheme = localStorage.getItem("theme");
                if (currentTheme === "dark") {
                    fileDisplay.classList.add('dark');
                }

                return fileDisplay;
            }

            function getFileType(filename) {
                const extension = filename.split('.').pop().toLowerCase();
                const docTypes = ['docx', 'doc'];
                const pdfTypes = ['pdf'];
                const imageTypes = ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'svg'];

                if (pdfTypes.includes(extension)) return 'PDF';
                if (docTypes.includes(extension)) return 'DOCX';
                if (imageTypes.includes(extension)) return 'Image';
                return extension.toUpperCase();
            }

            document.getElementById('attach-btn').addEventListener('click', () => {
                const tempInput = document.createElement('input');
                tempInput.type = 'file';
                tempInput.multiple = true;
                tempInput.accept = '.txt,.pdf,.docx,.doc,.png,.jpg,.jpeg';
                tempInput.style.display = 'none';
                document.body.appendChild(tempInput);

                tempInput.addEventListener('change', (event) => {
                    const existingFilesCount = document.querySelectorAll('#file-list .file-display').length;
                    const selectedFiles = Array.from(event.target.files);
                    const totalFiles = existingFilesCount + selectedFiles.length;

                    if (totalFiles > 5) {
                        showNotification();
                        document.body.removeChild(tempInput);
                        return;
                    }

                    const fileListEl = document.getElementById('file-list');

                    selectedFiles.forEach(file => {
                        const fileDisplay = createAttachmentFileDisplay(file);
                        fileListEl.appendChild(fileDisplay);
                    });

                    document.body.removeChild(tempInput);
                });

                tempInput.click();
            });

            function showNotification() {
                const notificationToast = document.getElementById('notification-toast');
                const template = document.getElementById('notification-template');
                notificationToast.innerHTML = '';
                const notificationElement = template.content.cloneNode(true);
                notificationToast.appendChild(notificationElement);

                notificationToast.classList.add('show');

                const closeButton = notificationToast.querySelector('.btn-close');
                closeButton.addEventListener('click', () => {
                    notificationToast.classList.remove('show');
                });

                setTimeout(() => {
                    notificationToast.classList.remove('show');
                }, 5000);
            }

            document.getElementById('send-btn').addEventListener('click', async () => {
                if (isSending) {
                    return;
                }
                submitPrompt();
            });

            document.getElementById('query').addEventListener('keydown', event => {
                if( event.key === 'Enter' && !event.ctrlKey && !event.shiftKey && !event.altKey && !event.metaKey ) { 
                    if (isSending) {
                        event.preventDefault();
                        return;
                    }
                    submitPrompt(); 
                    event.preventDefault(); 
                }
            });

            document.getElementById('reset-chat').addEventListener('click', async () => {
                const confirmReset = await Swal.fire({
                    title: 'Are you sure?',
                    text: "This will reset the conversation.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, reset it!'
                });
                
                if (confirmReset.isConfirmed) {
                    try {
                        const response = await fetch('/api/reset_conversation', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include'
                        });
                        if (response.ok) {
                            const data = await response.json();
                            const container = document.querySelector('.container.my-3');
                            container.innerHTML = '';
                            updateRemainingMessages(data.remaining_messages);
                            Swal.fire({
                                icon: 'success',
                                title: 'Reset',
                                text: 'Conversation has been reset.'
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Failed to reset the conversation.'
                            });
                        }
                    } catch (error) {
                        console.error('Error resetting conversation:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'An error occurred while resetting the conversation.'
                        });
                    }
                }
            });

            async function submitPrompt() {
                if (isSending) {
                    return;
                }
                isSending = true;
                const query = document.getElementById('query').value.trim();
                const resultsContainer = document.querySelector('.container.my-3');
                const sendBtn = document.getElementById('send-btn');
                const remainingMessagesEl = document.getElementById('remaining-messages');
                const fileListEl = document.getElementById('file-list');

                let remainingMessages = parseInt(remainingMessagesEl.textContent.replace('Remaining messages: ', '')) || 10;

                const files = Array.from(fileListEl.children).slice(0, 5).map(div => div.file);

                if( query || files.length > 0 ) {
                    sendBtn.classList.add('loading');

                    const formData = new FormData();
                    formData.append('query', query);

                    files.forEach((file, index) => {
                        formData.append('file', file);
                    });

                    const promptElement = document.createElement('div');
                    promptElement.classList.add('message-prompt');

                    if (query) {
                        const messageText = document.createElement('div');
                        messageText.innerHTML = marked.parse(query);
                        promptElement.appendChild(messageText);
                    }

                    if (files.length > 0) {
                        const filesContainer = document.createElement('div');
                        filesContainer.classList.add('files-container');
                        files.forEach(file => {
                            const fileDisplay = createChatFileDisplay(file);
                            filesContainer.appendChild(fileDisplay);
                        });
                        promptElement.appendChild(filesContainer);
                    }

                    resultsContainer.appendChild(promptElement);

                    document.getElementById('query').value = '';
                    fileListEl.innerHTML = '';
                    adjustHeight();

                    try {
                        const response = await fetch('/api/query', {
                            method: 'POST',
                            body: formData,
                            credentials: 'include'
                        });

                        if (!response.ok) {
                            if (response.status === 401) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Unauthorized',
                                    text: 'Your session has expired or is invalid. Please refresh the page.'
                                });
                            } else {
                                throw new Error('Network response was not ok');
                            }
                            return;
                        }

                        if (!response.body) {
                            throw new Error('ReadableStream not supported in this browser.');
                        }

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let messageContent = '';
                        const responseElement = document.createElement('div');
                        responseElement.classList.add('message-response');

                        resultsContainer.appendChild(responseElement);

                        const renderEveryNTokens = 5;
                        let tokenCounter = 0;

                        while (true) {
                            const { value, done } = await reader.read();
                            if (done) break;

                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n');

                            for (const line of lines) {
                                if (line.startsWith('data:')) {
                                    const jsonData = line.slice(5).trim();
                                    if (jsonData === '[DONE]') {
                                        break;
                                    }

                                    try {
                                        const data = JSON.parse(jsonData);
                                        if (data.content) {
                                            messageContent += data.content;
                                            tokenCounter++;

                                            if (tokenCounter % renderEveryNTokens === 0) {
                                                const tempElement = document.createElement('div');
                                                tempElement.innerHTML = messageContent;
                                                MathJax.typesetPromise([tempElement]).then(() => {
                                                    responseElement.innerHTML = marked.parse(tempElement.innerHTML);
                                                    MathJax.typesetPromise([responseElement]).catch(function (err) {
                                                        console.error('MathJax typeset failed:', err);
                                                    });
                                                }).catch(function (err) {
                                                    console.error('MathJax typeset failed:', err);
                                                });
                                            }
                                        }
                                        if (data.remaining_messages !== undefined) {
                                            updateRemainingMessages(data.remaining_messages);
                                        }
                                        if (data.error) {
                                            Swal.fire({
                                                icon: 'error',
                                                title: 'Error',
                                                text: data.error
                                            });
                                        }
                                    } catch (error) {
                                        console.error('Error parsing JSON:', error);
                                    }
                                }
                            }
                        }

                        if (messageContent) {
                            const tempElement = document.createElement('div');
                            tempElement.innerHTML = messageContent;
                            await MathJax.typesetPromise([tempElement]);
                            responseElement.innerHTML = marked.parse(tempElement.innerHTML);
                            await MathJax.typesetPromise([responseElement]);

                            const buttonContainer = document.createElement('div');
                            buttonContainer.classList.add('mt-2', 'd-flex', 'gap-2');

                            const copyButton = document.createElement('button');
                            copyButton.classList.add('btn', 'btn-sm', 'btn-outline-secondary');
                            copyButton.setAttribute('aria-label', 'Copy response');
                            copyButton.innerHTML = `
                                <span class="flex h-[30px] w-[30px] items-center justify-center">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="icon-md-heavy">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M7 5C7 3.34315 8.34315 2 10 2H19C20.6569 2 22 3.34315 22 5V14C22 15.6569 20.6569 17 19 17H17V19C17 20.6569 15.6569 22 14 22H5C3.34315 22 2 20.6569 2 19V10C2 8.34315 3.34315 7 5 7H7V5ZM9 7H14C15.6569 7 17 8.34315 17 10V15H19C19.5523 15 20 14.5523 20 14V5C20 4.44772 19.5523 4 19 4H10C9.44772 4 9 4.44772 9 5V7ZM5 9C4.44772 9 4 9.44772 4 10V19C4 19.5523 4.44772 20 5 20H14C14.5523 20 15 19.5523 15 19V10C15 9.44772 14.5523 9 14 9H5Z" fill="currentColor"></path>
                                    </svg>
                                </span>
                            `;
                            copyButton.addEventListener('click', () => {
                                const tempDiv = document.createElement('div');
                                tempDiv.innerHTML = responseElement.innerHTML;
                                tempDiv.querySelectorAll('.btn').forEach(btn => btn.remove());
                                const textToCopy = tempDiv.innerText;
                                navigator.clipboard.writeText(textToCopy).then(() => {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Copied',
                                        text: 'Response copied to clipboard.',
                                        toast: true,
                                        position: 'top-end',
                                        showConfirmButton: false,
                                        timer: 1500,
                                        timerProgressBar: true
                                    });
                                }).catch(err => {
                                    console.error('Failed to copy text: ', err);
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: 'Failed to copy text.'
                                    });
                                });
                            });

                            const downloadButton = document.createElement('button');
                            downloadButton.classList.add('btn', 'btn-sm', 'btn-outline-primary');
                            downloadButton.setAttribute('aria-label', 'Download response as DOCX');
                            downloadButton.innerHTML = `
                                <span class="flex h-[30px] w-[30px] items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="icon-md-heavy">
                                        <path d="M12 16V4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M6 10L12 16L18 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M4 20H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </span>
                            `;
                            downloadButton.addEventListener('click', () => {
                                const htmlContent = responseElement.innerHTML;
                                const fullHtml = `
                                    <html>
                                        <head>
                                            <meta charset="utf-8">
                                        </head>
                                        <body>
                                            ${htmlContent}
                                        </body>
                                    </html>
                                `;
                                const converted = htmlDocx.asBlob(fullHtml);
                                const url = URL.createObjectURL(converted);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = 'response.docx';
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                URL.revokeObjectURL(url);
                            });

                            buttonContainer.appendChild(copyButton);
                            buttonContainer.appendChild(downloadButton);
                            responseElement.appendChild(buttonContainer);
                        }

                    } catch (error) {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'An error occurred while processing your request. You need to reload the page.'
                        });
                    } finally {
                        sendBtn.classList.remove('loading');
                        isSending = false;
                    }
                } else { 
                    Swal.fire({
                        icon: 'info',
                        title: 'Error',
                        text: 'Please enter a question or attach files.'
                    }); 
                    isSending = false;
                    return; 
                }
            }

            function createChatFileDisplay(file) {
                const template = document.getElementById('chat-file-display-template');
                const fileDisplay = template.content.cloneNode(true).children[0];

                fileDisplay.querySelector('.file-name').textContent = file.name;
                const fileType = getFileType(file.name);
                fileDisplay.querySelector('.file-type').textContent = fileType;

                const fileIcon = fileDisplay.querySelector('.file-icon svg');
                if (fileType.toLowerCase() === 'pdf') {
                    fileIcon.innerHTML = `
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4Z" fill="currentColor"/>
                    `;
                } else if (fileType.toLowerCase() === 'docx' || fileType.toLowerCase() === 'doc') {
                    fileIcon.innerHTML = `
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4ZM10 12H14V14H10V12Z" fill="currentColor"/>
                    `;
                } else {
                    fileIcon.innerHTML = `
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4Z" fill="currentColor"/>
                    `;
                }

                var currentTheme = localStorage.getItem("theme");
                if (currentTheme === "dark") {
                    fileDisplay.classList.add('dark');
                }

                return fileDisplay;
            }

            function createAttachmentFileDisplay(file) {
                const template = document.getElementById('file-display-template');
                const fileDisplay = template.content.cloneNode(true).children[0];

                fileDisplay.querySelector('.file-name').textContent = file.name;
                const fileType = getFileType(file.name);
                fileDisplay.querySelector('.file-type').textContent = fileType;

                const fileIcon = fileDisplay.querySelector('.file-icon svg');
                if (fileType.toLowerCase() === 'pdf') {
                    fileIcon.innerHTML = `
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4ZM8 6C8 6.55228 7.55228 7 7 7C6.44772 7 6 6.55228 6 6C6 5.44772 6.44772 5 7 5C7.55228 5 8 5.44772 8 6ZM16 18H8V16H16V18Z" fill="currentColor"/>
                    `;
                } else if (fileType.toLowerCase() === 'docx' || fileType.toLowerCase() === 'doc') {
                    fileIcon.innerHTML = `
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4ZM10 12H14V14H10V12Z" fill="currentColor"/>
                    `;
                } else {
                    fileIcon.innerHTML = `
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M6 2C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2H6ZM6 4H14L20 10V20H6V4Z" fill="currentColor"/>
                    `;
                }

                fileDisplay.file = file;

                fileDisplay.querySelector('.remove-file-btn').addEventListener('click', () => {
                    fileDisplay.remove();
                });

                var currentTheme = localStorage.getItem("theme");
                if (currentTheme === "dark") {
                    fileDisplay.classList.add('dark');
                }

                return fileDisplay;
            }

            function getFileType(filename) {
                const extension = filename.split('.').pop().toLowerCase();
                const docTypes = ['docx', 'doc'];
                const pdfTypes = ['pdf'];
                const imageTypes = ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'svg'];

                if (pdfTypes.includes(extension)) return 'PDF';
                if (docTypes.includes(extension)) return 'DOCX';
                if (imageTypes.includes(extension)) return 'Image';
                return extension.toUpperCase();
            }

            function showNotification() {
                const notificationToast = document.getElementById('notification-toast');
                const template = document.getElementById('notification-template');
                notificationToast.innerHTML = '';
                const notificationElement = template.content.cloneNode(true);
                notificationToast.appendChild(notificationElement);

                notificationToast.classList.add('show');

                const closeButton = notificationToast.querySelector('.btn-close');
                closeButton.addEventListener('click', () => {
                    notificationToast.classList.remove('show');
                });

                setTimeout(() => {
                    notificationToast.classList.remove('show');
                }, 5000);
            }

        });
    </script>
</body>
</html>
